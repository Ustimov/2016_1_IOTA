<!DOCTYPE  html>
<html><head>
    <meta charset="utf-8" />
    <title><!-- TODO --></title>
    <link rel="stylesheet" href="/css/main.css" />
    <script src="/js/lib/jquery.js"></script>
    <script src="/js/tmpl/main.js"></script>
    <script src="/js/tmpl/scoreboard.js"></script>
    <script src="/js/tmpl/game.js"></script>
    <script src="/js/tmpl/login.js"></script>
    <script src="/js/index.js"></script>
</head><body>
    <!--
    <div id="page">
        <h1>Hello world!</h1>
    </div>
    -->
    <canvas id="canvas"></canvas>
    <script>
        /*
        var $page = $('#page');
        showMainScreen();
        */
        (function() {

            function Tile(width, height) {
                if (arguments.length != 2) {
                    throw new Error("Required two params")
                }

                var _width = width,
                    _height = height;

                this.getWidth = function () {
                    return _width;
                };

                this.getHeight = function () {
                    return _height;
                };
            }

            function Camera(x, y, width, height) {
                if (arguments.length != 4) {
                    throw new Error("Required four args")
                }

                var _x = x,
                    _y = y,
                    _width = width,
                    _height = height;

                this.getX = function () {
                    return _x;
                };

                this.getY = function () {
                    return _y;
                };

                this.getWidth = function () {
                    return _width;
                };

                this.getHeight = function () {
                    return _height;
                };

                this.scroll = function(deltaX, deltaY) {
                    if (arguments.length != 2) {
                        throw new Error("Required two params")
                    }

                    _x += deltaX;
                    _y += deltaY;
                };

                this.scale = function(scale, ratioX, ratioY) {
                    var oldWidth = _width,
                        oldHeight = _height;

                    _width *= scale;
                    _height *= scale;

                    _x += (oldWidth - _width) * ratioX;
                    _y += (oldHeight - _height) * ratioY;
                };

                this.fill = function(ratioX, ratioY) {
                    var tileX = _x + _width * ratioX,
                        tileY = _y + _height * ratioY;
                    offScreenCanvasContext.fillRect(Math.floor(tileX / 100) * 100, Math.floor(tileY / 100) * 100, 100, 100);
                    context.drawImage(offScreenCanvas, camera.getX(), camera.getY(), camera.getWidth(), camera.getHeight(),
                            0, 0, window.innerWidth, window.innerHeight);
                };
            }

            function Card(x, y, width, height) {
                if (arguments.length != 4) {
                    throw new Error("Required four args")
                }

                var _x = x,
                    _y = y,
                    _width = width,
                    _height = height,
                    _isInHand = true;

                this.getX = function () {
                    return _x;
                };

                this.setX = function(x) {
                    _x = x;
                };

                this.getY = function () {
                    return _y;
                };

                this.setY = function(y) {
                    _y = y;
                };

                this.getWidth = function () {
                    return _width;
                };

                this.getHeight = function () {
                    return _height;
                };

                this.isPointInsideRect = function(x, y) {
                    if (_x <= x && x <= _x + _width && _y <= y && y <= _y + _height) {
                        return true
                    }
                    return false;
                };

                this.isInHand = function () {
                    return _isInHand;
                };

                this.toTable = function (windowWidth, windowHeight) {
                    _isInHand = false;
                    var tileX = camera.getX() + _x * camera.getWidth() / windowWidth + _width / 2,
                        tileY = camera.getY() + _y * camera.getHeight() / windowHeight + _height / 2;
                    offScreenCanvasContext.fillRect(Math.floor(tileX / 100) * 100,
                            Math.floor(tileY / 100) * 100, 100, 100);
                };
            }

            function Hand(x, y) {
                var _x = x,
                    _y = y;

                var cards = [
                    new Card(x - 230, y - 50, 100, 100),
                    new Card(x - 110, y - 50, 100, 100),
                    new Card(x + 130, y - 50, 100, 100),
                    new Card(x + 10, y - 50, 100, 100)
                ];

                this.draw = function () {
                    for (var i = 0; i < cards.length; i++) {
                        if (cards[i].isInHand()) {
                            context.fillRect(cards[i].getX(), cards[i].getY(), cards[i].getWidth(), cards[i].getHeight());
                        }
                    }
                };

                this.getCard = function(x, y) {
                    for (var i = 0; i < cards.length; i++) {
                        if (cards[i].isPointInsideRect(x, y) && cards[i].isInHand()) {
                            return cards[i];
                        }
                    }
                    return null;
                };
            }

            var tileHeight = 100,
                tileWidth = 100,
                tileRowCount = 34,
                tileColumnCount = 34;

            var offScreenCanvas = document.createElement('canvas');
            offScreenCanvas.height = tileHeight * tileRowCount;
            offScreenCanvas.width = tileWidth * tileColumnCount;

            var offScreenCanvasContext = offScreenCanvas.getContext('2d');
            for (var i = 1; i <= tileColumnCount; i++) {
                //offScreenCanvasContext.beginPath();
                offScreenCanvasContext.moveTo(tileWidth * i, 0);
                offScreenCanvasContext.lineTo(tileWidth * i, tileWidth * tileColumnCount);
                //offScreenCanvasContext.stroke();

                //offScreenCanvasContext.beginPath();
                offScreenCanvasContext.moveTo(0, tileHeight * i);
                offScreenCanvasContext.lineTo(tileHeight * tileRowCount, tileHeight * i);
                //offScreenCanvasContext.stroke();
            }
            offScreenCanvasContext.stroke();
            offScreenCanvasContext.fillRect(1000, 1000, 100, 100);

            var scale = 1,
                offsetX = 0,
                offsetY = 0;

            var canvas = document.getElementById('canvas');
            canvas.style.background = '#f70';
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            canvas.onmousewheel = function (event) {
                scale += event.wheelDelta / 1000;
                console.log(event.wheelDelta);
                context.clearRect(0, 0, canvas.width, canvas.height);
                if (event.wheelDelta < 0) {
                    camera.scale(0.9, event.clientX / window.innerWidth, event.clientY / window.innerHeight);
                } else {
                    camera.scale(1.1, event.clientX / window.innerWidth, event.clientY / window.innerHeight);
                }
                redraw();
            };

            function redraw() {
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.drawImage(offScreenCanvas, camera.getX(), camera.getY(), camera.getWidth(), camera.getHeight(),
                        0, 0, window.innerWidth, window.innerHeight);
                hand.draw();
            }

            canvas.onclick = function (event) {
                //camera.fill(event.clientX / window.innerWidth, event.clientY / window.innerHeight);
            };

            var initialX = 0,
                initialY = 0,
                move = false,
                selectedCard,
                drag = false;

            canvas.onmousedown = function (event) {
                selectedCard = hand.getCard(event.clientX, event.clientY);
                if (selectedCard != null) {
                    drag = true;
                    console.log("dragged");
                    return;
                }
                move = true;
                initialX = event.clientX;
                initialY = event.clientY;
            };

            canvas.onmousemove = function(event) {
                if (drag) {
                    selectedCard.setX(event.clientX - selectedCard.getWidth() / 2);
                    selectedCard.setY(event.clientY - selectedCard.getHeight() / 2);
                    redraw();
                    return;
                }
                if (!move) {
                    return;
                }
                offsetX += initialX - event.clientX;
                offsetY += initialY - event.clientY;
                camera.scroll(initialX - event.clientX, initialY - event.clientY);
                initialX = event.clientX;
                initialY = event.clientY;
                redraw();
            };

            canvas.onmouseup = function(event) {
                move = false;
                if (drag) {
                    drag = false;
                    selectedCard.toTable(window.innerWidth, window.innerHeight);
                    redraw();
                }
            };

            var context = canvas.getContext('2d');
            var camera = new Camera(0, 0, window.innerWidth, window.innerHeight);
            var hand = new Hand(window.innerWidth / 2, window.innerHeight - 100);

            redraw();

            /*
            var img = new Image();
            img.onload = function () {
                context.drawImage(img, 0, 0, 800, 200);
            };
            img.src = 'images/telegram.png';
            */

        })();
    </script>
</body></html>
